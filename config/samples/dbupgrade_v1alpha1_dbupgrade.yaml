apiVersion: dbupgrade.subbug.learning/v1alpha1
kind: DBUpgrade
metadata:
  name: dbupgrade-sample
spec:
  migrations:
    image: "postgres:15-migrations"
    dir: "/migrations"
  database:
    type: "selfHosted"
    connection:
      urlSecretRef:
        name: "db-connection-secret"
        key: "url"  # Default is "url" if not specified
  checks:
    pre:
      minPodVersions:
        - selector:
            matchLabels:
              app: "my-app"
          minVersion: "1.2.0"
          containerName: "app"
          disallowDowngrade: false
      metrics:
        - name: "pre-check-cpu"
          source: "Custom"
          metricName: "cpu_usage_percent"
          target:
            type: "Pods"
            pods:
              selector:
                matchLabels:
                  app: "my-app"
          threshold:
            operator: "<="
            value: "80"  # resource.Quantity format as decimal (e.g., "5", "1.5", "250m", "0.05" for 5%)
          reduce: "Max"
          bakeSeconds: 0
          intervalSeconds: 15
    post:
      metrics:
        - name: "post-check-errors"
          source: "External"
          metricName: "error_rate"
          target:
            type: "Object"
            object:
              ref:
                apiVersion: "v1"
                kind: "Service"
                name: "my-service"
              selector:
                matchLabels:
                  app: "my-app"
          threshold:
            operator: "<"
            value: "0.01"  # resource.Quantity format as decimal (e.g., "0.01" for 1% error rate)
          reduce: "Avg"
          bakeSeconds: 30
          intervalSeconds: 10
  runner:
    activeDeadlineSeconds: 3600
---
apiVersion: dbupgrade.subbug.learning/v1alpha1
kind: DBUpgrade
metadata:
  name: dbupgrade-aws-sample
spec:
  migrations:
    image: "myapp/migrations:v2.0.0"
    dir: "/migrations"
  database:
    type: "awsRds"
    aws:
      roleArn: "arn:aws:iam::123456789012:role/myapp-db-migrator"
      region: "us-east-1"
      host: "mydb.abc123.us-east-1.rds.amazonaws.com"
      port: 5432
      dbName: "myapp"
      username: "migrator"
  checks:
    pre:
      minPodVersions:
        - selector:
            matchLabels:
              app: "myapp"
          minVersion: "v1.5.0"
          containerName: "app"
      metrics:
        - name: "pre-check-cpu"
          source: "Custom"
          metricName: "cpu_usage_percent"
          target:
            type: "Pods"
            pods:
              selector:
                matchLabels:
                  app: "myapp"
          threshold:
            operator: "<="
            value: "80"
          reduce: "Max"
  runner:
    activeDeadlineSeconds: 900
